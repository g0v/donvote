// Generated by LiveScript 1.2.0
var x$;
x$ = angular.module('donvote');
x$.controller('newvote', function($scope, $timeout, $http){
  var quickTimeUpdate, quickPlanUpdate;
  $scope.clean = function(){
    $scope.plan = {
      name: "",
      desc: ""
    };
    $scope.vote = {
      name: "",
      desc: "",
      karma: [],
      plan: [],
      discuss: [],
      startDate: new Date(),
      startCountDown: 3600000,
      duration: 86400000,
      endCountDown: 3600000,
      planCount: 2,
      qualifiedRate: 25,
      karmaRate: 10,
      karmaCount: 10,
      agreeRate: 20,
      answerRate: 80,
      voteRate: 75,
      maxChoiceCount: 2,
      rankMethod: '1',
      endByDuration: false,
      disclosedBallot: false,
      nullTicketRate: 40,
      validVoteRate: 66,
      obtainRate: 30
    };
    $scope.quick = {};
    return $scope.custom = {
      time: false,
      plan: false,
      perm: false,
      adv: false,
      disclosedBallot: 0,
      endDateType: 1
    };
  };
  $scope.clean();
  $scope.$watch('custom.disclosedBallot', function(v){
    return $scope.vote.disclosedBallot = v ? true : false;
  });
  $scope.$watch('vote.disclosedBallot', function(v){
    return $scope.custom.disclosedBallot = v ? 1 : 0;
  });
  quickTimeUpdate = function(v){
    if (v) {
      if (v[1]) {
        return import$($scope.vote, {
          startDate: new Date(),
          startMethod: '2',
          endMethod: '1'
        });
      } else if (v[2]) {
        return import$($scope.vote, {
          startMethod: '1',
          endMethod: '1'
        });
      } else if (v[3]) {
        return import$($scope.vote, {
          startDate: new Date(),
          startMethod: '2',
          endMethod: '2',
          endByDuration: true,
          duration: 86400000
        });
      }
    }
  };
  quickPlanUpdate = function(v){
    if (v) {
      if (v[1]) {
        $scope.vote.voteMethod = '1';
        return $scope.vote.plan = [
          {
            name: '贊同'
          }, {
            name: '反對'
          }
        ];
      } else if (v[2]) {
        $scope.vote.plan = [
          {
            name: '贊同'
          }, {
            name: '反對'
          }, {
            name: '無感'
          }
        ];
        return $scope.vote.voteMethod = '1';
      } else {
        return $scope.vote.voteMethod = '4';
      }
    }
  };
  $scope.$watch('quick.time', quickTimeUpdate);
  $scope.$watch('custom.time', function(it){
    if (!it) {
      return quickTimeUpdate($scope.quick.time);
    }
  });
  $scope.$watch('quick.plan', quickPlanUpdate);
  $scope.$watch('custom.plan', function(it){
    if (!it) {
      return quickPlanUpdate($scope.quick.plan);
    }
  });
  $scope.newplan = function(p){
    var ref$;
    if (p.name) {
      return $scope.vote.plan.push((ref$ = {}, ref$.name = p.name, ref$.desc = p.desc, ref$));
    }
  };
  $scope.removeplan = function(p){
    return $scope.vote.plan = $scope.vote.plan.filter(function(it){
      return it.name !== p.name;
    });
  };
  $scope.state = 1;
  return $scope.newvote = function(v){
    $scope.state = 2;
    return $http({
      url: '/api/vote/',
      method: 'POST',
      data: JSON.stringify($scope.vote)
    }).success(function(d){
      $scope.clean();
      return $timeout(function(){
        $scope.state = 3;
        return $timeout(function(){
          return $scope.state = 1;
        }, 4000);
      }, 2000);
    }).error(function(e){
      return console.error(e);
    });
  };
});
function import$(obj, src){
  var own = {}.hasOwnProperty;
  for (var key in src) if (own.call(src, key)) obj[key] = src[key];
  return obj;
}